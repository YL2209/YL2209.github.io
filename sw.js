(()=>{const t="NaoKuoBlogCache",e="https://id.v3/",n="naokuo.top",s=n=>caches.open(t).then((t=>t.put(e,new Response(JSON.stringify(n))))),r=()=>caches.match(e).then((t=>t?.json()));self.addEventListener("install",(()=>{self.skipWaiting()})),self.addEventListener("activate",(t=>t.waitUntil(clients.claim())));let o={simple:{clean:!0,match:t=>{const e=n;return t.host===e&&t.pathname.match(/\/|\.(js|html|css|woff2|woff|ttf|cur)$/)}},cdn:{clean:!0,match:t=>["cdn.cbd.int","unpkg.com","npm.elemecdn.com","npm.onmicrosoft.cn","cdn.bootcdn.net","fonts.gstatic.com","font.onmicrosoft.cn","i0.hdslb.com"].includes(t.host)&&t.pathname.match(/\.(js|css|woff2|woff|ttf|cur)$/)},img:{clean:!0,match:t=>{const e=n;return t.host===e&&t.pathname.match(/(.*?)\.(png|jpe?g|svg|webp|gif|bmp|psd|tiff|tga|ico|eps)/)}},thirdparty:{clean:!0,match:function(t){return"unpkg.com"===t.host&&t.pathname.match(/(.*?)\.(png|webp)/)}}},c=t=>{if(t.startsWith("https://npm.elemecdn.com"))return{timeout:3e3,list:[t,"https://unpkg.com/".concat(new URL(t).pathname),"https://cdn.jsdelivr.net/npm/".concat(new URL(t).pathname),"https://npm.onmicrosoft.cn/".concat(new URL(t).pathname)]}};const a=(t,e,n=null)=>{const s={cache:e?"no-store":"default",mode:"cors",credentials:"same-origin"};if(!n&&!(n=c(t.url)))return fetch(t,s);const r=n.list,o=new Array(r.length),a=e=>fetch(new Request(r[e],t),Object.assign({signal:(o[e]=new AbortController).signal},s)).then((t=>h(t)?{r:t,i:e}:Promise.reject()));return new Promise(((e,s)=>{let c=!0;const h=()=>{c=!1,Promise.any([l,...Array.from({length:r.length-1},((t,e)=>e+1)).map((t=>a(t)))]).then((t=>{for(let e=0;e!==r.length;++e)e!==t.i&&o[e].abort();e(t.r)})).catch((()=>s(`请求 ${t.url} 失败`)))},i=setTimeout(h,n.timeout),l=a(0).then((t=>{c&&(clearTimeout(i),e(t.r))})).catch((()=>(c&&(clearTimeout(i),h()),Promise.reject())))}))},h=t=>t.ok||[301,302,307,308].includes(t.status),i=new Map;self.addEventListener("fetch",(e=>{let n=e.request,s=new URL(n.url);if("GET"!==n.method||!n.url.startsWith("http"))return;let r=s.hostname+s.pathname+s.search,o=i.get(r);if(o)return e.respondWith(new Promise(((t,e)=>{i.get(r).push({s:t,e:e})})));i.set(r,o=[]);const u=t=>e.respondWith(t.then((t=>{for(let e of o)e.s(t.clone())})).catch((t=>{for(let e of o)e.e(t)})).then((()=>(i.delete(r),t)))),f=l(s);if(f){let e=`https://${s.host}${s.pathname}`;e.endsWith("/index.html")&&(e=e.substring(0,e.length-10)),f.search&&(e+=s.search),u(caches.match(e).then((s=>s??a(n,!0).then((n=>{if(h(n)){const s=n.clone();caches.open(t).then((t=>t.put(e,s)))}return n})))))}else{const t=c(n.url);u(t?a(n,!1,t):fetch(n).catch((t=>new Response(t,{status:499}))))}})),self.addEventListener("message",(t=>{"update"===t.data&&u().then((e=>t.source.postMessage({type:"update",update:e.list,version:e.version,old:e.old})))}));const l=t=>{if("localhost"!==t.hostname)for(let e in o){const n=o[e];if(n.match(t))return n}},u=()=>{const n=t=>r().then((e=>{const{info:n,global:r}=t,o={global:r,local:n[0].version,escape:e?.escape??0};if(!e)return s(o),{version:o,old:e};let c=new f,a=((t,e,n)=>{for(let s of e){const{version:e,change:r}=s;if(e===n)return!1;if(r)for(let e of r)t.push(new m(e))}return!0})(c,n,e.local);return s(o),a&&(r!==e.global?c.force=!0:c.refresh=!0),{list:c,version:o,old:e}}));return a(new Request("/update.json"),!1).then((s=>{if(h(s))return s.json().then((s=>n(s).then((n=>{const s={version:n.version,old:n.old};return n.list?(r=n.list,caches.open(t).then((t=>t.keys().then((n=>Promise.all(n.map((async n=>{const s=n.url;return s!==e&&r.match(s)?(t.delete(n),s):null}))))).then((t=>t.filter((t=>t))))))).then((t=>0===t.length?null:t)).then((t=>Object.assign({list:t},s))):s;var r}))));throw`加载 update.json 时遇到异常，状态码：${s.status}`}))};function f(){const t=[];this.push=e=>{t.push(e)},this.match=e=>{if(this.force)return!0;if(e=new URL(e),this.refresh)return l(e).clean;for(let n of t)if(n.match(e))return!0;return!1}}function m(t){const e=e=>{const n=t.value;if(Array.isArray(n)){for(let t of n)if(e(t))return!0;return!1}return e(n)};this.match=(()=>{switch(t.flag){case"html":return t=>t.pathname.match(/(\/|\.html)$/);case"end":return t=>e((e=>t.href.endsWith(e)));case"begin":return t=>e((e=>t.pathname.startsWith(e)));case"str":return t=>e((e=>t.href.includes(e)));case"reg":return t=>e((e=>t.href.match(new RegExp(e,"i"))));default:throw`未知表达式：${JSON.stringify(t)}`}})()}})();